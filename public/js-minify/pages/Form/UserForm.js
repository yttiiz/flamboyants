var d=class{createHTMLElements(...e){let t=[];for(let o of e)t.push(document.createElement(o));return t}createSameHTMLElements(e,t){let o=[];for(let s=0;s<t;s++)o.push(document.createElement(e));return o}setSameHTMLElementAttributes(e,t,...o){if(o.length===1){t===!0?o[0].setAttribute(e,""):o[0][e]=t;return}for(let s of o)t===!0?s.setAttribute(e,""):s[e]=t}insertChildren(e,...t){for(let o of t)e.appendChild(o)}};var h=(r,e)=>{let t,o,s=(a,l="photo")=>(a=document.createElement("input"),a.type="file",a.name=l,a.accept=".png, .jpg, .webp, .jpeg",a),n=(a,l)=>{a.addEventListener("change",u=>{if(u.currentTarget.files.length===1){let{name:m,size:y}=u.currentTarget.files[0],g=new Intl.NumberFormat("fr-FR",{maximumFractionDigits:2}).format(y/1e3);l instanceof HTMLDivElement?(l.innerHTML=`Fichier choisi : <b>${m}</b> (taille: ${g} ko).`,l.classList.contains("none")&&(l.classList.remove("none"),l.classList.add("show-file"))):l.value=`${m} (taille: ${g} ko)`}})};r.currentTarget.closest("form").action.includes("/profil")?o=r.currentTarget.nextElementSibling:o=r.currentTarget.closest("div").previousElementSibling,r.currentTarget.parentNode.querySelector("input")?t=r.currentTarget.parentNode.querySelector("input"):(t=e?s(t,e):s(t),r.currentTarget.closest("div").insertBefore(t,r.currentTarget),n(t,o)),t.click()},S=r=>{let e=new FormData(r);for(let[t,o]of e)(o===""||typeof o=="object"&&o.size===0||t.includes("file"))&&e.delete(t);return e},q=r=>{for(let e of r)e.querySelector("textarea")&&(e.querySelector("textarea").value=""),e.querySelector("input")&&(e.querySelector("input").value="")},v=(r,e)=>{let t=typeof e[r.name]=="string"||typeof e[r.name]=="number";r.type!=="password"&&t&&(r.type==="date"?r.value=e[r.name].split("T").at(0):r.value=e[r.name])},p=()=>"?apiKey=ESdv9jDqQGsuL9XEsqlS6KWN",L=class{constructor(){}static setFormData=S;static removeInputsValues=q;static setUserDialogContent=(r,{title:e,paragraph:t})=>{r.querySelector("h2").textContent=e,r.querySelector("p").textContent=t};static setProductDialogContent=(r,{isUserConnected:e,title:t,paragraph:o})=>{r.querySelector("h2").textContent=t,r.querySelector("p").textContent=o,e||e===void 0?r.querySelector(".login-register").classList.contains("none")||r.querySelector(".login-register").classList.add("none"):r.querySelector(".login-register").classList.contains("none")&&r.querySelector(".login-register").classList.remove("none")};static setProfilDialogContent=(r,{title:e,paragraph:t,status:o,handler:s})=>{if(r.querySelector("h2").textContent=e,r.querySelector("p").textContent=t,o)switch(o){case 201:{r.querySelector("form").classList.contains("none")||r.querySelector("form").classList.add("none");break}case 200:{r.querySelector("form").classList.contains("none")||r.querySelector("form").classList.add("none"),r.querySelector(".show-message-to-user").classList.contains("none")&&r.querySelector(".show-message-to-user").classList.remove("none"),s&&(r.querySelector("button").removeEventListener("click",s),r.querySelector("button").addEventListener("click",()=>globalThis.location.href="/"));break}}else r.querySelector("form").classList.contains("none")&&r.querySelector("form").classList.remove("none")};static setHomeDialogContent=(r,{title:e,paragraph:t},o)=>{r.querySelector("h2").textContent=e,r.querySelector("p").innerHTML=t;let s=globalThis.navigator.userAgent.includes("Firefox"),n=r.querySelector("input"),a=o.closest("div").nextElementSibling.href;if(n.value=a,s){let l=r.querySelector("div > div"),u=l.querySelector("button");u&&l.removeChild(u);return}r.querySelector("div > div button").addEventListener("click",async l=>{let u=await navigator.permissions.query({name:"clipboard-write"});(u.state==="granted"||u.state==="prompt")&&(navigator.clipboard.writeText(a),n.select(),l.target.textContent="Copi\xE9",setTimeout(()=>{globalThis.getSelection().removeAllRanges(),l.target.textContent="Copier"},2e3))})};static getOrCreateElement=({parent:r,cssSelector:e,hmtlTag:t})=>{let o;return r.querySelector(e)?o=r.querySelector(e):(o=document.createElement(t),r.appendChild(o)),o}},i=class c extends L{static id=e=>`#data-${e}-form`;static handleInputFile=h;static hydrateInput=v;static displayDialogRegisterDetails=async e=>{let{message:t,title:o}=await e.json(),s=document.querySelector("#data-user-form > dialog");c.setUserDialogContent(s,{title:o,paragraph:t}),s.showModal()};static displayDialogforgotPassword=()=>{let e=document.querySelector("dialog[data-reset-password]");e.querySelector("h2").textContent||c.setUserDialogContent(e,{title:"Mot de passe oubli\xE9 ?",paragraph:"Saisissez votre adresse e-mail et nous vous enverrons des instructions pour r\xE9initialiser votre mot de passe."}),e.showModal()};static sendNewPasswordToUser=async e=>{let t=e.currentTarget.previousElementSibling,o=t.querySelector("input")?.value.trim();if(o)try{let s=await fetch("/get-user-firstname"+p(),{method:"POST",body:JSON.stringify({email:o})});if(s.ok&&s.status===200){let{firstname:n}=await s.json(),a=await fetch("/send-forgot-password-email"+p(),{method:"POST",body:JSON.stringify({firstname:n,email:o})});if(a.ok){let{message:l}=await a.json();c.displaySendForgotPasswordEmailMessage(t,l)}}}catch(s){console.log(s)}else if(!t.querySelector("p")){let s=document.createElement("p");s.textContent="Veuillez renseigner une adresse email !",s.style.color="red",t.appendChild(s)}};static showLoginError=async e=>{let{message:t}=await e.json(),o=document.querySelector("form > span");o.textContent=t,o.classList.contains("none")&&o.classList.remove("none")};static displaySendForgotPasswordEmailMessage=(e,t)=>{let o=e.closest(".send-user-email"),s=o.closest("dialog").querySelector("p");o.innerHTML="",s.innerHTML=t};static displayDialogToDeleteAccount=()=>{let e=document.querySelector("#data-profil-form > dialog");c.setProfilDialogContent(e,{title:"Suppression du compte",paragraph:"Etes-vous vraiment s\xFBr de vouloir supprimer votre compte ?"}),e.showModal()};static displayDialogProfilUpdatedDetails=async e=>{let t="#data-profil-form",o=e.status,{message:s,photo:n}=await e.json(),a=document.querySelector(t+" > dialog");n&&(document.querySelector(t+" figure > img").src=n,document.querySelector(".user-photo > div").classList.add("none")),c.setProfilDialogContent(a,{title:"Mise \xE0 jour",paragraph:s,status:o}),a.showModal()};static displayDialogProfilDeletedDetails=async(e,t)=>{let o=e.status,{message:s}=await e.json(),n=document.querySelector("#data-profil-form > dialog");c.setProfilDialogContent(n,{title:"Compte supprim\xE9",paragraph:s,status:o,handler:t})};static showErrorMsg=async(e,t)=>{let o=e.status,s=t==="/profil"?"profil":"user",{errorMsg:n}=await e.json();c.#e({msg:n+o,dataSet:"error"},s)};static#e=({msg:e,dataSet:t},o)=>{let s=document.querySelector(c.id(o)+" .container"),n=c.getOrCreateElement({parent:s,cssSelector:"p[data-msg-infos]",hmtlTag:"p"});n.dataset.msgInfos=t,n.textContent=e}};var f=class extends d{initForm=(e="user")=>{let[t,o]=document.querySelectorAll(`#data-${e}-form form`);if(this.#e(),document.querySelector(".loading-text")){let s=document.querySelector(`#data-${e}-form .container`),n=document.querySelector(".loading-text"),a=s.querySelector("img.loading-image");s.removeChild(n),a.classList.remove("loading-image")}if(t.action.includes("/login")&&this.handleForgotPassword(),t.addEventListener("submit",s=>this.#t(s)),t.action.includes("/register")&&t.querySelector(".search-photo button").addEventListener("click",i.handleInputFile),o&&o.addEventListener("submit",s=>this.#t(s)),document.querySelectorAll("dialog").length>0){let s=document.querySelectorAll("dialog");for(let n of s){let a=n.querySelectorAll("button[data-close]");for(let l of a)l.addEventListener("click",this.#o)}}};#e=()=>{if(document.querySelector("#user-session .login")){let e=document.querySelectorAll("#user-session .login a");switch(globalThis.location.pathname.split("/")[1]){case"login":{e[0].addEventListener("click",o=>o.preventDefault());break}case"register":{e[1].addEventListener("click",o=>o.preventDefault());break}}}if(document.querySelector("#user-session span[data-profil-link]")){let e=document.querySelectorAll("#user-session span[data-profil-link] > a");for(let t of e)t.addEventListener("click",o=>o.preventDefault())}};handleForgotPassword=()=>{let e=document.querySelector("button[data-forgot-password]"),t=document.querySelector("button[data-send-user-email]");e.addEventListener("click",i.displayDialogforgotPassword),t.addEventListener("click",i.sendNewPasswordToUser)};renderProfilForm=(e,t)=>{let o=document.querySelector(".user-photo"),s=o.querySelector("img"),n=document.querySelectorAll(".user-infos input");s.src=t.photo,s.alt=`photo de ${t.firstname} ${t.lastname}`;for(let a of n)i.hydrateInput(a,t);this.initForm(e),o.querySelector("button").addEventListener("click",i.handleInputFile),document.querySelector(".delete-account button").addEventListener("click",()=>{i.displayDialogToDeleteAccount()})};renderError=({errorMsg:e})=>{if(document.querySelector("#data-profil-form")){let t=document.querySelector("#data-profil-form").querySelector(".error-msg");t.innerHTML+=e,t.classList.remove("none")}};#t=async e=>{e.preventDefault();let t=e.target.dataset.type==="delete-account",o=t?null:i.setFormData(e.target),s=location.pathname==="/profil"?t?"DELETE":"PUT":null,n=await fetch(e.target.action,{method:s??"POST",body:o,headers:{"Access-Control-Allow-Origin":"*"},mode:"cors"});if(location.pathname!=="/profil"){let a=e.target.querySelectorAll("label");i.removeInputsValues(a)}if(n.ok&&(n.status===200||n.status===201))if(n.redirected)globalThis.location.href=n.url;else switch(e.target.action){case location.origin+"/login":i.showLoginError(n);break;case location.origin+"/register":i.displayDialogRegisterDetails(n);break;case location.origin+"/profil":{t?i.displayDialogProfilDeletedDetails(n,this.#o):i.displayDialogProfilUpdatedDetails(n);break}}else i.showErrorMsg(n,location.pathname)};#o=e=>{e.currentTarget.closest("dialog").close(),location.href.includes("register")&&(location.href="/")}};export{f as UserFormPage};
