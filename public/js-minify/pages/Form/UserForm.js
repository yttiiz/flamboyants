var d=class{createHTMLElements(...e){let t=[];for(let o of e)t.push(document.createElement(o));return t}createSameHTMLElements(e,t){let o=[];for(let r=0;r<t;r++)o.push(document.createElement(e));return o}setSameHTMLElementAttributes(e,t,...o){if(o.length===1){t===!0?o[0].setAttribute(e,""):o[0][e]=t;return}for(let r of o)t===!0?r.setAttribute(e,""):r[e]=t}insertChildren(e,...t){for(let o of t)e.appendChild(o)}};var g=(n,e)=>{let t,o,r=(a,l="photo")=>(a=document.createElement("input"),a.type="file",a.name=l,a.accept=".png, .jpg, .webp, .jpeg",a),s=(a,l)=>{a.addEventListener("change",c=>{if(c.currentTarget.files.length===1){let{name:u,size:v}=c.currentTarget.files[0],f=new Intl.NumberFormat("fr-FR",{maximumFractionDigits:2}).format(v/1e3);l instanceof HTMLDivElement?(l.innerHTML=`Fichier choisi : <b>${u}</b> (taille: ${f} ko).`,l.classList.contains("none")&&(l.classList.remove("none"),l.classList.add("show-file"))):l.value=`${u} (taille: ${f} ko)`}})};n.currentTarget.closest("form").action.includes("/profil")?o=n.currentTarget.nextElementSibling:o=n.currentTarget.closest("div").previousElementSibling,n.currentTarget.parentNode.querySelector("input")?t=n.currentTarget.parentNode.querySelector("input"):(t=e?r(t,e):r(t),n.currentTarget.closest("div").insertBefore(t,n.currentTarget),s(t,o)),t.click()},y=n=>{let e=new FormData(n);for(let[t,o]of e)(o===""||typeof o=="object"&&o.size===0||t.includes("file"))&&e.delete(t);return e},h=n=>{for(let e of n)e.querySelector("textarea")&&(e.querySelector("textarea").value=""),e.querySelector("input")&&(e.querySelector("input").value="")},S=(n,e)=>{let t=typeof e[n.name]=="string"||typeof e[n.name]=="number";n.type!=="password"&&t&&(n.type==="date"?n.value=e[n.name].split("T").at(0):n.value=e[n.name])};var p=()=>"?apiKey=ESdv9jDqQGsuL9XEsqlS6KWN";var m=class{constructor(){}static setFormData=y;static removeInputsValues=h;static setUserDialogContent=(e,{title:t,paragraph:o})=>{e.querySelector("h2").textContent=t,e.querySelector("p").innerHTML=o};static setProductDialogContent=(e,{isUserConnected:t,title:o,paragraph:r})=>{e.querySelector("h2").textContent=o,e.querySelector("p").textContent=r,t||t===void 0?e.querySelector(".login-register").classList.contains("none")||e.querySelector(".login-register").classList.add("none"):e.querySelector(".login-register").classList.contains("none")&&e.querySelector(".login-register").classList.remove("none")};static setProfilDialogContent=(e,{title:t,paragraph:o,status:r,handler:s})=>{if(e.querySelector("h2").textContent=t,e.querySelector("p").textContent=o,r)switch(r){case 201:{e.querySelector("form").classList.contains("none")||e.querySelector("form").classList.add("none");break}case 200:{e.querySelector("form").classList.contains("none")||e.querySelector("form").classList.add("none"),e.querySelector(".show-message-to-user").classList.contains("none")&&e.querySelector(".show-message-to-user").classList.remove("none"),s&&(e.querySelector("button").removeEventListener("click",s),e.querySelector("button").addEventListener("click",()=>globalThis.location.href="/"));break}}else e.querySelector("form").classList.contains("none")&&e.querySelector("form").classList.remove("none")};static setHomeDialogContent=(e,{title:t,paragraph:o},r)=>{e.querySelector("h2").textContent=t,e.querySelector("p").innerHTML=o;let s=globalThis.navigator.userAgent.includes("Firefox"),a=e.querySelector("input"),l=r.closest("div").nextElementSibling.href;if(a.value=l,s){let c=e.querySelector("div > div"),u=c.querySelector("button");u&&c.removeChild(u);return}e.querySelector("div > div button").addEventListener("click",async c=>{let u=await navigator.permissions.query({name:"clipboard-write"});(u.state==="granted"||u.state==="prompt")&&(navigator.clipboard.writeText(l),a.select(),c.target.textContent="Copi\xE9",setTimeout(()=>{globalThis.getSelection().removeAllRanges(),c.target.textContent="Copier"},2e3))})};static getOrCreateElement=({parent:e,cssSelector:t,hmtlTag:o})=>{let r;return e.querySelector(t)?r=e.querySelector(t):(r=document.createElement(o),e.appendChild(r)),r}};var i=class n extends m{static id=e=>`#data-${e}-form`;static handleInputFile=g;static hydrateInput=S;static displayDialogRegisterDetails=async e=>{let{message:t,title:o}=await e.json(),r=document.querySelector("#data-user-form > dialog");e.status<300&&r.querySelector("button[data-close]").addEventListener("click",()=>location.href="/"),n.setUserDialogContent(r,{title:o,paragraph:t}),r.showModal()};static displayDialogforgotPassword=()=>{let e=document.querySelector("dialog[data-reset-password]");e.querySelector("h2").textContent||n.setUserDialogContent(e,{title:"Mot de passe oubli\xE9 ?",paragraph:"Saisissez votre adresse e-mail et nous vous enverrons des instructions pour r\xE9initialiser votre mot de passe."}),e.showModal()};static sendNewPasswordToUser=async e=>{let t=e.currentTarget.previousElementSibling,o=t.querySelector("input")?.value.trim();if(o)try{let r=await fetch("/get-user-firstname"+p(),{method:"POST",body:JSON.stringify({email:o})});if(r.ok&&r.status===200){let{firstname:s}=await r.json(),a=await fetch("/send-forgot-password-email"+p(),{method:"POST",body:JSON.stringify({firstname:s,email:o})});if(a.ok){let{message:l}=await a.json();n.displaySendForgotPasswordEmailMessage(t,l)}}}catch(r){console.log(r)}else if(!t.querySelector("p")){let r=document.createElement("p");r.textContent="Veuillez renseigner une adresse email !",r.style.color="red",t.appendChild(r)}};static showLoginError=async e=>{let{message:t}=await e.json(),o=document.querySelector("form > span");o.textContent=t,o.classList.contains("none")&&o.classList.remove("none")};static displaySendForgotPasswordEmailMessage=(e,t)=>{let o=e.closest(".send-user-email"),r=o.closest("dialog").querySelector("p");o.innerHTML="",r.innerHTML=t};static displayDialogToDeleteAccount=()=>{let e=document.querySelector("#data-profil-form > dialog");n.setProfilDialogContent(e,{title:"Suppression du compte",paragraph:"Etes-vous vraiment s\xFBr de vouloir supprimer votre compte ?"}),e.showModal()};static displayDialogProfilUpdatedDetails=async e=>{let t="#data-profil-form",o=e.status,{message:r,photo:s}=await e.json(),a=document.querySelector(t+" > dialog");s&&(document.querySelector(t+" figure > img").src=s,document.querySelector(".user-photo > div").classList.add("none")),n.setProfilDialogContent(a,{title:"Mise \xE0 jour",paragraph:r,status:o}),a.showModal()};static displayDialogProfilDeletedDetails=async(e,t)=>{let o=e.status,{message:r}=await e.json(),s=document.querySelector("#data-profil-form > dialog");n.setProfilDialogContent(s,{title:"Compte supprim\xE9",paragraph:r,status:o,handler:t})};static showErrorMsg=async(e,t)=>{let o=e.status,r=t==="/profil"?"profil":"user",{errorMsg:s}=await e.json();n.#e({msg:s+o,dataSet:"error"},r)};static#e=({msg:e,dataSet:t},o)=>{let r=document.querySelector(n.id(o)+" .container"),s=n.getOrCreateElement({parent:r,cssSelector:"p[data-msg-infos]",hmtlTag:"p"});s.dataset.msgInfos=t,s.textContent=e}};var q=class extends d{initForm=(e="user")=>{let[t,o]=document.querySelectorAll(`#data-${e}-form form`);if(this.#e(),document.querySelector(".loading-text")){let r=document.querySelector(`#data-${e}-form .container`),s=document.querySelector(".loading-text"),a=r.querySelector("img.loading-image");r.removeChild(s),a.classList.remove("loading-image")}if(t.action.includes("/login")&&this.handleForgotPassword(),t.addEventListener("submit",r=>this.#t(r)),t.action.includes("/register")&&t.querySelector(".search-photo button").addEventListener("click",i.handleInputFile),o&&o.addEventListener("submit",r=>this.#t(r)),document.querySelectorAll("dialog").length>0){let r=document.querySelectorAll("dialog");for(let s of r){let a=s.querySelectorAll("button[data-close]");for(let l of a)l.addEventListener("click",this.#o)}}};#e=()=>{if(document.querySelector("#user-session .login")){let e=document.querySelectorAll("#user-session .login a");switch(globalThis.location.pathname.split("/")[1]){case"login":{e[0].addEventListener("click",o=>o.preventDefault());break}case"register":{e[1].addEventListener("click",o=>o.preventDefault());break}}}if(document.querySelector("#user-session span[data-profil-link]")){let e=document.querySelectorAll("#user-session span[data-profil-link] > a");for(let t of e)t.addEventListener("click",o=>o.preventDefault())}};handleForgotPassword=()=>{let e=document.querySelector("button[data-forgot-password]"),t=document.querySelector("button[data-send-user-email]");e.addEventListener("click",i.displayDialogforgotPassword),t.addEventListener("click",i.sendNewPasswordToUser)};renderProfilForm=(e,t)=>{let o=document.querySelector(".user-photo"),r=o.querySelector("img"),s=document.querySelectorAll(".user-infos input");r.src=t.photo,r.alt=`photo de ${t.firstname} ${t.lastname}`;for(let a of s)i.hydrateInput(a,t);this.initForm(e),o.querySelector("button").addEventListener("click",i.handleInputFile),document.querySelector(".delete-account button").addEventListener("click",()=>{i.displayDialogToDeleteAccount()})};renderError=({errorMsg:e})=>{if(document.querySelector("#data-profil-form")){let t=document.querySelector("#data-profil-form").querySelector(".error-msg");t.innerHTML+=e,t.classList.remove("none")}};#t=async e=>{e.preventDefault();let t=e.target.dataset.type==="delete-account",o=t?null:i.setFormData(e.target),r=location.pathname==="/profil"?t?"DELETE":"PUT":null,s=await fetch(e.target.action,{method:r??"POST",body:o,headers:{"Access-Control-Allow-Origin":"*"},mode:"cors"});if(location.pathname!=="/profil"){let a=e.target.querySelectorAll("label");i.removeInputsValues(a)}if(s.ok&&(s.status===200||s.status===201))if(s.redirected)globalThis.location.href=s.url;else switch(e.target.action){case location.origin+"/login":i.showLoginError(s);break;case location.origin+"/register":i.displayDialogRegisterDetails(s);break;case location.origin+"/profil":{t?i.displayDialogProfilDeletedDetails(s,this.#o):i.displayDialogProfilUpdatedDetails(s);break}}else{if(s.status<500&&location.href.includes("register"))return i.displayDialogRegisterDetails(s);i.showErrorMsg(s,location.pathname)}};#o=e=>{e.currentTarget.closest("dialog").close()}};export{q as UserFormPage};
